var pageInlineSaver=function(){"use strict";function e(e,n){for(var t=document.getElementsByTagName(e),i=[],a=0;a<t.length;a++)(!n||"function"==typeof n&&n(t[a]))&&i.push(t[a]);return i}function n(e,n){var t=e.split("/"),i=n.split("/");t.pop();for(var a=0;a<i.length;a++)"."!==i[a]&&(".."===i[a]?t.pop():t.push(i[a]));return t.join("/")}return{insertTimestamp:function(){var e=document.createElement("meta");e.setAttribute("name","generator"),e.setAttribute("value","Saved inlined page from "+window.location.href+" on "+new Date),document.head.appendChild(e)},setBaseLink:function(){if(0===document.getElementsByTagName("base").length){var e=document.createElement("base");e.setAttribute("href",window.location.href),document.head.appendChild(e)}},inlineResources:function(){var n;if(options.timeout>0&&(n=setTimeout(()=>{pageInlineSaver.stopInlining||(console.info("Timeout reached: saving page with "+(this.initiatedInlines-this.completedInlines)+" inlines left unfinished out of "+this.foundInlinables+" found inlinables"),pageInlineSaver.saveFile())},1e3*options.timeout)),options.inlineCss){var t=e("link",function(e){return"stylesheet"===e.getAttribute("rel").toLowerCase()});pageInlineSaver.increaseFoundInlineables(this.foundInlinables+t.length)}if(options.inlineJs||options.removeJs){var i=e("script",function(e){return e.hasAttribute("src")});pageInlineSaver.increaseFoundInlineables(this.foundInlinables+i.length)}if(options.inlineImg){var a=e("img",function(e){return e.hasAttribute("src")&&null!==e.getAttribute("src")});a.concat(e("embed",function(e){return e.hasAttribute("src")&&e.hasAttribute("type")&&e.getAttribute("type").startsWith("image/")})),pageInlineSaver.increaseFoundInlineables(this.foundInlinables+a.length);var r=e("source",function(e){return e.hasAttribute("srcset")&&e.getAttribute("srcset")&&(e.hasAttribute("type")&&e.getAttribute("type").startsWith("image/")||"picture"===e.parentElement.nodeName.toLowerCase())})}if(pageInlineSaver.handleMessage("Inlining "+this.foundInlinables+" external resources"),options.deepInlineCss){var l=e("style");for(let e=0;e<l.length;e++)pageInlineSaver.inlineStylesheetInternal(l[e].innerText,document.getElementsByTagName("base")[0])}if(this.foundInlinables>0)try{if(options.inlineCss)for(let e=0;e<t.length;e++){let n=t[e].getAttribute("href");pageInlineSaver.downloadResource({url:n,resourceDeclaration:t[e]},pageInlineSaver.inlineStylesheet,!1)}if(options.inlineJs||options.removeJs)for(let e=0;e<i.length;e++)if(options.inlineJs&&!options.removeJs){let n=i[e].getAttribute("src");pageInlineSaver.downloadResource({url:n,resourceDeclaration:i[e]},pageInlineSaver.inlineScript,!1)}else i[e].parentElement.removeChild(i[e]);if(options.inlineImg){for(let e=0;e<a.length;e++){let n=a[e].getAttribute("src");n.startsWith("data:")?pageInlineSaver.completedInline():pageInlineSaver.downloadResource({url:n,resourceDeclaration:a[e]},pageInlineSaver.inlineImage,!0)}for(let e=0;e<r.length;e++){let n=r[e].getAttribute("srcset").split(",");for(let t=0;t<n.length;t++){let i=n[t].split(" ")[0].trim();i.startsWith("data:")?pageInlineSaver.completedInline():(pageInlineSaver.increaseFoundInlineables(1),pageInlineSaver.downloadResource({url:i,resourceDeclaration:i,srcElement:r[e],omitCssUrl:!0},pageInlineSaver.inlineStylesheetImage,!0))}}}}catch(e){pageInlineSaver.handleError(e),clearTimeout(n),pageInlineSaver.saveFile()}else clearTimeout(n),pageInlineSaver.saveFile()},saveFile:function(){if(!pageInlineSaver.stopInlining){pageInlineSaver.stopInlining=!0;var e=document.getElementById("SimmetricPageSaverInfoPanel");e.parentElement.removeChild(e);var n=document.getElementById("SimmetricPageSaverDimmer");n.parentElement.removeChild(n);var t=document.getElementById("SimmetricPageSaverInlineableCounter");t.parentElement.removeChild(t);var i=document.getElementById("SimmetricPageSaverStopButton");i.parentElement.removeChild(i);var a=document.getElementById("loadingSpinner");a.parentElement.removeChild(a);var r=pageInlineSaver.DOMtoString(document);chrome.runtime.sendMessage({action:"saveFile",source:r,url:window.location.href})}},DOMtoString:function(e){for(var n="",t=e.firstChild;t;){switch(t.nodeType){case Node.ELEMENT_NODE:n+=t.outerHTML;break;case Node.TEXT_NODE:n+=t.nodeValue;break;case Node.CDATA_SECTION_NODE:n+="<![CDATA["+t.nodeValue+"]]>";break;case Node.COMMENT_NODE:n+="\x3c!--' + node.nodeValue + '--\x3e";break;case Node.DOCUMENT_TYPE_NODE:n+="<!DOCTYPE "+t.name+(t.publicId?' PUBLIC "'+t.publicId+'"':"")+(!t.publicId&&t.systemId?" SYSTEM":"")+(t.systemId?' "'+t.systemId+'"':"")+">\n"}t=t.nextSibling}return n},handleError:function(e){document.getElementById("SimmetricPageSaverInfoPanel").innerHTML+='<span style="color: #a00;">An error occurred! Press F12 to see what it is.</span><br>',console.error(e)},handleMessage:function(e){document.getElementById("SimmetricPageSaverInfoPanel").innerHTML+=e+"<br>"},increaseFoundInlineables:function(e){document.getElementById("SimmetricPageSaverInlineableCounter").innerText=e,pageInlineSaver.foundInlinables=e},downloadResource:function(e,n,t){this.initiatedInlines++,console.debug("Inlining "+e.url);try{fetch(e.url).then(i=>(t?i.blob():i.text()).then(t=>{n(e.srcElement,e.resourceDeclaration,t,i.headers.get("Content-Type"),!!e.omitCssUrl&&e.omitCssUrl)})).catch(e=>{pageInlineSaver.handleError(e),pageInlineSaver.completedInline()})}catch(e){pageInlineSaver.handleError(e),pageInlineSaver.completedInline()}},inlineImage:function(e,n,t,i){pageInlineSaver.getImageAsDataUrl(t,i,function(e){let t="source"===n.nodeName.toLowerCase();n.setAttribute(t?"srcset":"src",e),pageInlineSaver.completedInline()})},inlineScript:function(e,n,t,i){t="//<![CDATA[\n"+t.replace(new RegExp("<\/script>","gi"),"&lt;/script&gt;")+"\n//]]>",n.removeAttribute("src"),n.innerHTML=t,pageInlineSaver.completedInline()},inlineStylesheet:function(e,n,t,i){let a=document.createElement("style");a.setAttribute("type","text/css"),a.innerHTML=t,a.setAttribute("href",n.getAttribute("href")),n.hasAttribute("media")&&a.setAttribute("media",n.getAttribute("media")),n.parentNode.replaceChild(a,n),options.deepInlineCss&&pageInlineSaver.inlineStylesheetInternal(t,a),pageInlineSaver.completedInline()},inlineStylesheetImage:function(e,n,t,i,a=!1){pageInlineSaver.getImageAsDataUrl(t,i,function(t){e.innerHTML=e.innerHTML.replace(n,function(){return a?t:"url("+t+")"}),pageInlineSaver.completedInline()})},inlineStylesheetImport:function(e,n,t,i){e.innerHTML=e.innerHTML.replace(n,function(){return t}),pageInlineSaver.inlineStylesheetInternal(e.innerHTML,e),pageInlineSaver.completedInline()},inlineStylesheetInternal:function(e,t){for(var i=t.getAttribute("href"),a=/url\("?'?([ a-zA-Z0-9:\-\.\\\/_&?=@]+)"?'?\)/gi,r=a.exec(e);r;){if(!r[1].startsWith("data:")){var l=r[1];r[1].startsWith("http")||r[1].startsWith("/")||void 0===i||(l=n(i,l)),pageInlineSaver.increaseFoundInlineables(this.foundInlinables++),pageInlineSaver.downloadResource({url:l,resourceDeclaration:r[0],srcElement:t},pageInlineSaver.inlineStylesheetImage,!0)}r=a.exec(e)}for(r=/@import\s+"?'?([ a-zA-Z0-9:\-\.\\\/_&?=@]+)"?'?/gi.exec(e);r;){let l=r[1];r[1].startsWith("http")||r[1].startsWith("/")||void 0===i||(l=n(i,l)),pageInlineSaver.increaseFoundInlineables(pageInlineSaver.foundInlinables++),pageInlineSaver.downloadResource({url:l,resourceDeclaration:r[0],srcElement:t},pageInlineSaver.inlineStylesheetImport,!1),r=a.exec(e)}},completedInline:function(){pageInlineSaver.completedInlines++,pageInlineSaver.initiatedInlines===pageInlineSaver.completedInlines&&pageInlineSaver.saveFile()},getImageAsDataUrl:function(e,n,t){if(!this.stopInlining)try{var i=new FileReader;i.readAsDataURL(e),i.onloadend=function(){t(i.result)}}catch(e){pageInlineSaver.handleError(e),pageInlineSaver.saveFile()}},errorText:"",foundInlinables:0,initiatedInlines:0,completedInlines:0,stopInlining:!1}}();try{var dimmer=document.createElement("div");dimmer.id="SimmetricPageSaverDimmer",dimmer.setAttribute("style","position: fixed; z-index: 9998; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; opacity: 0.8"),document.getElementsByTagName("body")[0].appendChild(dimmer);var infoPanel=document.createElement("div");infoPanel.id="SimmetricPageSaverInfoPanel",infoPanel.setAttribute("style","position: fixed; z-index: 9999; top: 0; left: 25%; width: 75%; height: 100%; color: #fff; text-align: left; font-size: 14pt; display:none"),document.getElementsByTagName("body")[0].appendChild(infoPanel);var inlineableCounter=document.createElement("div");inlineableCounter.id="SimmetricPageSaverInlineableCounter",inlineableCounter.setAttribute("style","position: fixed; z-index: 9999; top: 0; left: 0; width: 100px; height: 50px; background-color: #fff; color: #000; font-size: 50px; font-weight: bold; padding: 20px; text-align: right; float: left; display:none"),document.getElementsByTagName("body")[0].appendChild(inlineableCounter);var stopButton=document.createElement("button");stopButton.id="SimmetricPageSaverStopButton",stopButton.onclick=pageInlineSaver.saveFile,stopButton.setAttribute("style","position: fixed; z-index: 9999; left: 0; bottom: 0; width: 200px; height: 80px; background-color: #a66; color: $fff; display:none"),stopButton.innerText="Interrupt and save page now",document.getElementsByTagName("body")[0].appendChild(stopButton);var spinner=document.createElement("img");spinner.id="loadingSpinner",spinner.src=chrome.extension.getURL("img/Spinner.svg"),spinner.setAttribute("style","position: fixed; z-index: 9999; left:50%; top:30%; width: 200px; margin-left:-100px"),document.getElementsByTagName("body")[0].appendChild(spinner),pageInlineSaver.handleMessage("Inlining page..."),pageInlineSaver.foundInlinables=0,options.timeout>0&&pageInlineSaver.handleMessage("Timeout set to "+options.timeout+" seconds."),options.addTimestamp&&pageInlineSaver.insertTimestamp(),pageInlineSaver.setBaseLink(),pageInlineSaver.inlineResources()}catch(e){pageInlineSaver.handleError(e)}