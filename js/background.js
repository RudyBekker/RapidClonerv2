var tabs=[];const authCred={username:"user_723x",password:"letmein50"};function getOptions(){return localStorage.options?JSON.parse(localStorage.options):{skin:"moono-lisa",toolbar:"CustomFull"}}function setOptions(e){localStorage.options=JSON.stringify(e)}chrome.browserAction.onClicked.addListener(function(e){}),chrome.extension.onConnect.addListener(function(e){e.onMessage.addListener(function(t){t.init&&(tabs[e.sender.tab.id]={port:e})})}),chrome.tabs.onRemoved.addListener(function(e){tabs[e]&&delete tabs[e]});var menu=[];menu.test=chrome.contextMenus.create({title:"Save page as one file",contexts:["page"],onclick:function(){saveInlinedPage()}});var isActive=!1,animationIndex=0;function saveInlinedPage(){chrome.tabs.query({currentWindow:!0,active:!0},function(e){startActivity(),chrome.tabs.executeScript(e[0].id,{code:"var options = "+JSON.stringify(getOptions())},function(){chrome.tabs.executeScript(e[0].id,{file:"js/savePage.js"},function(){chrome.runtime.lastError&&console.error(chrome.runtime.lastError)})})})}function saveFile(e){endActivity();for(var t=new Blob(["\ufeff",e.source],{encoding:"UTF-8",type:"text/html;charset=utf-8"}),n=decodeURIComponent(e.url).replace("http://","").replace("https://","").split(/[\.\/\\:\?&=\[\]\|~]/),o=[],i=0;i<n.length;i++)n[i]&&n[i].length>0&&o.push(decodeURIComponent(n[i]));var r=o.join("-");console.debug(r),chrome.downloads.download({url:URL.createObjectURL(t),filename:r+".html"})}function startActivity(){isActive=!0,indicateActivity()}function endActivity(){isActive=!1}function indicateActivity(){chrome.browserAction}function getOption(e,t){try{var n=window.localStorage.getItem(e);return void 0!==n&&null!==n?n:t}catch(t){console.log("Error getting option "+e)}return null}function getOptions(){return{inlineJs:"true"===getOption("inlineJs","true"),inlineCss:"true"===getOption("inlineCss","true"),deepInlineCss:"true"===getOption("deepInlineCss","true"),inlineImg:"true"===getOption("inlineImg","true"),inlineMedia:"true"===getOption("inlineMedia","true"),timeout:getOption("timeout",30),addTimestamp:"true"===getOption("addTimestamp","true"),removeJs:"true"===getOption("removeJs","false")}}function setOption(e,t){try{window.localStorage.removeItem(e),window.localStorage.setItem(e,t)}catch(t){console.log("Error setting option "+e)}}function isLoggedIn(){}function injectEditor(){chrome.tabs.query({currentWindow:!0,active:!0},function(e){console.log(e),tabs[e[0].id].port.postMessage({toggleEditor:!0,options:getOptions()})})}chrome.runtime.onMessage.addListener(function(e,t,n){if("saveFile"===e.action)saveFile(e);else if(t.tab&&"SAVE_PAGE_BG"==e.type)saveInlinedPage();else{if("CHECK_AUTH"==e.type)return console.log("message from login popup"),chrome.storage.local.get({loggedIn:!1},function(e){n({loggedIn:e.loggedIn})}),!0;if("INJECT_EDITOR"==e.type)injectEditor();else if("TRY_LOGIN"==e.type)return console.log(e.data),authCred.username==e.data.uname&&authCred.password==e.data.pws&&chrome.storage.local.set({loggedIn:!0},function(){n({loggedIn:!0})}),!0}});